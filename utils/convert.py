import os
from tqdm import tqdm
from config.config import config
from utils.check import is_pe_file


def batch_convert(input_dir, output_dir, convert_func, verbose=False):
    '''
    Convert all the files in the input directory to grayscale images.
    Assumes that the input directory contains only one class of files.

    Parameters:
    - input_dir (str): The directory of the input files.
    - output_dir (str): The directory of the output images.
    - verbose (bool): Whether to print the information when current file is not a PE file.
    '''
    file_list = os.listdir(input_dir)
    file_list_bar = tqdm(file_list)

    for filename in file_list_bar:
        if config['check_file']:
            if is_pe_file(input_dir, filename):
                convert_func(input_dir, output_dir, filename)
            elif verbose:
                print(f"{input_dir}/{filename} is not a PE file!")
        else:
            convert_func(input_dir, output_dir, filename)
        file_list_bar.set_description(f"Processing {filename}")


def convert(input_path, output_path, convert_func):
    '''
    Convert all the files in the input directory to grayscale images.
    Assumes that the input directory contains serveral subdirectories, each of which contains only one class of files.

    Parameters:
    - input_path (str): The directory of the input subdirectories.
    - output_path (str): The directory of the output subdirectories.
    '''
    for subdir in os.listdir(input_path):
        batch_convert(os.path.join(input_path, subdir),
                os.path.join(output_path, subdir), convert_func)
