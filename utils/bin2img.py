import os
import numpy as np
import matplotlib.pyplot as plt
from array import array
import cv2
from pathlib import Path
import pefile


def bin_to_gray_image(file_path, img_path=None, is_show=False):
    '''
    Convert a Windows PE file to grayscale image.
    Use the algorithm from <Malware images: visualization and automatic classification>.
    '''
    if img_path is None:
        img_path = os.path.join(os.path.dirname(file_path), Path(file_path).stem + '.png')

    file_size = os.path.getsize(file_path)
    file_size_kb = file_size / 1024
    size_range = [0, 10, 30, 60, 100, 200, 500, 1000]
    width_arr = [32, 64, 128, 256, 384, 512, 768, 1024]
    idx = np.searchsorted(size_range, file_size_kb, side='right') - 1
    width = width_arr[idx]

    img = array('B')
    with open(file_path, 'rb') as f:
        img.fromfile(f, file_size)

    img = np.array(img, dtype=np.uint8)
    img.resize(int(np.ceil(file_size/width)), width)

    if is_show:
        plt.imshow(img, cmap='gray')
        plt.show()
    plt.imsave(img_path, img, cmap='gray')


def bin_to_dct_image(file_path, img_path=None, is_show=False):
    '''
    Convert a Windows PE file to DCT image.
    Use the algorithm from <Malware Detection Using Frequency Domain-Based Image Visualization and Deep Learning>.
    '''
    if img_path is None:
        img_path = os.path.join(os.path.dirname(file_path), Path(file_path).stem + '.png')

    with open(file_path, 'rb') as file:
        content = file.read()

    img = np.zeros((256,256))
    for i in range(len(content)-1):
        img[content[i],content[i+1]] += 1

    img[0,0] = 0
    img = np.round(img/np.max(img)*255)
    img = cv2.dct(img)
    
    if is_show:
        plt.imshow(img, cmap='gray')
        plt.show()
    plt.imsave(img_path, img, cmap='gray')


def bin_to_gray_image_exclude_rsrc(file_path, img_path=None, is_show=False):
    '''
    Exclude rsrc section
    '''
    if img_path is None:
        img_path = os.path.join(os.path.dirname(file_path), Path(file_path).stem + '.png')

    try:
        pe = pefile.PE(file_path)

        rsrc_section = None
        for section in pe.sections:
            if section.Name.decode(errors='ignore').strip('\x00') == '.rsrc':
                rsrc_section = section
                break
        
        img = array('B')
        with open(file_path, 'rb') as f:
            img.fromfile(f, os.path.getsize(file_path))
        
        if rsrc_section:
            img = img[:rsrc_section.VirtualAddress] + img[rsrc_section.VirtualAddress + rsrc_section.Misc_VirtualSize:]
        
        img = np.array(img, dtype=np.uint8)
        
        img_length = len(img)
        width = int(np.ceil(np.sqrt(img_length)))
        height = int(np.ceil(img_length/width))

        resized_img = np.zeros(height * width, dtype=np.uint8)
        resized_img[:img.shape[0]] = img
        resized_img = resized_img.reshape(height, width)

        if is_show:
            plt.imshow(resized_img, cmap='gray')
            plt.show()
        plt.imsave(img_path, resized_img, cmap='gray', format='png')
    
    except Exception as e:
        print(f"Error processing {file_path}: {str(e)}")
        

if __name__ == '__main__':
    dir = r'./data/section/'
    for file in os.listdir(dir):
        bin_to_gray_image(os.path.join(dir,file))
